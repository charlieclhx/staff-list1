<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>供应商SGS报告管理系统</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
        }
        
        .table thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .expired {
            background-color: #ffe6e6;
        }
        
        .expiring {
            background-color: #fff9e6;
        }
        
        .file-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }
        
        .action-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-valid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-expiring {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .modal-content {
            border-radius: 10px;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: var(--secondary-color);
            background-color: #f0f8ff;
        }
        
        .file-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-actions button {
            margin-left: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题区域 -->
        <div class="header text-center">
            <h1><i class="fas fa-file-contract me-2"></i>供应商SGS报告管理系统</h1>
            <p class="mb-0">基于LeanCloud的多机数据共享平台</p>
        </div>
        
        <!-- 控制面板 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" class="form-control" placeholder="搜索供应商、产品名称或代号...">
                        </div>
                    </div>
                    <div class="col-md-8 text-md-end">
                        <button class="btn btn-primary" id="addReportBtn">
                            <i class="fas fa-plus me-1"></i> 添加报告
                        </button>
                        <button class="btn btn-success" id="importBtn">
                            <i class="fas fa-file-import me-1"></i> 导入JSON
                        </button>
                        <button class="btn btn-info" id="exportBtn">
                            <i class="fas fa-file-export me-1"></i> 导出JSON
                        </button>
                        <button class="btn btn-secondary" id="printBtn">
                            <i class="fas fa-print me-1"></i> 打印
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计信息 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalReports">0</h4>
                                <p class="mb-0">总报告数</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="validReports">0</h4>
                                <p class="mb-0">有效报告</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="expiringReports">0</h4>
                                <p class="mb-0">即将到期</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="expiredReports">0</h4>
                                <p class="mb-0">已过期</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-times-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 报告列表 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>供应商SGS报告列表</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showExpired">
                    <label class="form-check-label text-white" for="showExpired">显示过期报告</label>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="reportsTable">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>供应商</th>
                                <th>产品名称</th>
                                <th>产品代号</th>
                                <th>报告文件</th>
                                <th>上传日期</th>
                                <th>到期日期</th>
                                <th>状态</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>显示 <span id="displayCount">0</span> 条记录，共 <span id="totalCount">0</span> 条</div>
                    <nav>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- 分页将通过JavaScript动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <div class="footer">
            <p>供应商SGS报告管理系统 &copy; 2023 | 基于LeanCloud云服务</p>
        </div>
    </div>
    
    <!-- 添加/编辑报告模态框 -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">添加供应商SGS报告</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <input type="hidden" id="reportId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="supplier" class="form-label">供应商 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="supplier" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="uploadDate" class="form-label">上传日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="uploadDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productNames" class="form-label">产品名称 (多个用逗号分隔)</label>
                                <textarea class="form-control" id="productNames" rows="2" placeholder="例如: 产品A, 产品B, 产品C"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productCodes" class="form-label">产品代号 (多个用逗号分隔)</label>
                                <textarea class="form-control" id="productCodes" rows="2" placeholder="例如: P001, P002, P003"></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">到期日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expiryDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">上传报告文件 (支持PDF, JPG, PNG等格式，单个文件最大10MB)</label>
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                <p class="mb-1">点击或拖拽文件到此处上传</p>
                                <p class="text-muted small">支持PDF, JPG, PNG, JPEG等格式，单个文件最大10MB</p>
                                <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            </div>
                            <div class="file-list" id="fileList">
                                <!-- 上传的文件列表将显示在这里 -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="remarks" class="form-label">备注</label>
                            <textarea class="form-control" id="remarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveReportBtn">保存报告</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 查看报告模态框 -->
    <div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewReportModalLabel">查看SGS报告</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>供应商:</strong> <span id="viewSupplier"></span></p>
                            <p><strong>产品名称:</strong> <span id="viewProductNames"></span></p>
                            <p><strong>产品代号:</strong> <span id="viewProductCodes"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>上传日期:</strong> <span id="viewUploadDate"></span></p>
                            <p><strong>到期日期:</strong> <span id="viewExpiryDate"></span></p>
                            <p><strong>状态:</strong> <span id="viewStatus" class="status-badge"></span></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p><strong>备注:</strong> <span id="viewRemarks"></span></p>
                    </div>
                    <div>
                        <p><strong>报告文件:</strong></p>
                        <div id="viewFileList">
                            <!-- 文件列表将显示在这里 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <!-- 打印功能库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.js"></script>
    
    <script>
        // LeanCloud 初始化
        const APP_ID = 'FsVjHfMtOxl1PLF8u76XAA87-gzGzoHsz';
        const APP_KEY = '65lS1h9UnpHhbbL34YXGSlbh';
        const SERVER_URL = 'https://fsvjhfmt.lc-cn-n1-shared.com';
        
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURLs: SERVER_URL
        });
        
        // 全局变量
        let reports = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredReports = [];
        
        // DOM 元素
        const reportsTableBody = document.getElementById('reportsTableBody');
        const searchInput = document.getElementById('searchInput');
        const addReportBtn = document.getElementById('addReportBtn');
        const saveReportBtn = document.getElementById('saveReportBtn');
        const reportForm = document.getElementById('reportForm');
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const viewReportModal = new bootstrap.Modal(document.getElementById('viewReportModal'));
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const showExpiredCheckbox = document.getElementById('showExpired');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const printBtn = document.getElementById('printBtn');
        
        // 上传的文件数组
        let uploadedFiles = [];
        let filesToDelete = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadReports();
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 搜索功能
            searchInput.addEventListener('input', filterReports);
            
            // 添加报告按钮
            addReportBtn.addEventListener('click', function() {
                resetForm();
                reportModal.show();
            });
            
            // 保存报告按钮
            saveReportBtn.addEventListener('click', saveReport);
            
            // 文件上传区域点击事件
            fileUploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件输入变化事件
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖放文件事件
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUploadArea.style.borderColor = '#3498db';
                fileUploadArea.style.backgroundColor = '#f0f8ff';
            });
            
            fileUploadArea.addEventListener('dragleave', function() {
                fileUploadArea.style.borderColor = '#ccc';
                fileUploadArea.style.backgroundColor = '';
            });
            
            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUploadArea.style.borderColor = '#ccc';
                fileUploadArea.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
            
            // 显示过期报告切换
            showExpiredCheckbox.addEventListener('change', filterReports);
            
            // 导入按钮
            importBtn.addEventListener('click', importData);
            
            // 导出按钮
            exportBtn.addEventListener('click', exportData);
            
            // 打印按钮
            printBtn.addEventListener('click', printTable);
        }
        
        // 从LeanCloud加载报告数据
        async function loadReports() {
            try {
                const query = new AV.Query('SGSReport');
                query.descending('createdAt');
                const results = await query.find();
                
                reports = results.map(item => {
                    return {
                        id: item.id,
                        supplier: item.get('supplier'),
                        productNames: item.get('productNames') || [],
                        productCodes: item.get('productCodes') || [],
                        files: item.get('files') || [],
                        uploadDate: item.get('uploadDate'),
                        expiryDate: item.get('expiryDate'),
                        remarks: item.get('remarks') || '',
                        createdAt: item.createdAt,
                        updatedAt: item.updatedAt
                    };
                });
                
                updateStatistics();
                filterReports();
            } catch (error) {
                console.error('加载报告失败:', error);
                alert('加载报告数据失败，请检查网络连接或控制台日志。');
            }
        }
        
        // 更新统计信息
        function updateStatistics() {
            const total = reports.length;
            const now = new Date();
            const thirtyDaysFromNow = new Date(now);
            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            
            let valid = 0;
            let expiring = 0;
            let expired = 0;
            
            reports.forEach(report => {
                const expiryDate = new Date(report.expiryDate);
                
                if (expiryDate < now) {
                    expired++;
                } else if (expiryDate <= thirtyDaysFromNow) {
                    expiring++;
                } else {
                    valid++;
                }
            });
            
            document.getElementById('totalReports').textContent = total;
            document.getElementById('validReports').textContent = valid;
            document.getElementById('expiringReports').textContent = expiring;
            document.getElementById('expiredReports').textContent = expired;
        }
        
        // 筛选报告
        function filterReports() {
            const searchTerm = searchInput.value.toLowerCase();
            const showExpired = showExpiredCheckbox.checked;
            const now = new Date();
            
            filteredReports = reports.filter(report => {
                // 搜索条件
                const matchesSearch = 
                    report.supplier.toLowerCase().includes(searchTerm) ||
                    report.productNames.some(name => name.toLowerCase().includes(searchTerm)) ||
                    report.productCodes.some(code => code.toLowerCase().includes(searchTerm)) ||
                    report.remarks.toLowerCase().includes(searchTerm);
                
                // 过期报告筛选
                const expiryDate = new Date(report.expiryDate);
                const isExpired = expiryDate < now;
                
                return matchesSearch && (showExpired || !isExpired);
            });
            
            renderTable();
        }
        
        // 渲染表格
        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageReports = filteredReports.slice(startIndex, endIndex);
            
            reportsTableBody.innerHTML = '';
            
            if (pageReports.length === 0) {
                reportsTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">没有找到匹配的报告</p>
                        </td>
                    </tr>
                `;
            } else {
                pageReports.forEach((report, index) => {
                    const serialNumber = startIndex + index + 1;
                    const uploadDate = new Date(report.uploadDate).toLocaleDateString();
                    const expiryDate = new Date(report.expiryDate).toLocaleDateString();
                    
                    // 确定状态
                    const now = new Date();
                    const expiry = new Date(report.expiryDate);
                    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                    
                    let statusText, statusClass;
                    
                    if (daysUntilExpiry < 0) {
                        statusText = '已过期';
                        statusClass = 'status-expired';
                    } else if (daysUntilExpiry <= 30) {
                        statusText = `${daysUntilExpiry}天后过期`;
                        statusClass = 'status-expiring';
                    } else {
                        statusText = '有效';
                        statusClass = 'status-valid';
                    }
                    
                    // 文件图标
                    const fileIcons = report.files.map(file => {
                        const ext = file.name.split('.').pop().toLowerCase();
                        let iconClass = 'fas fa-file';
                        
                        if (ext === 'pdf') iconClass = 'fas fa-file-pdf';
                        else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) iconClass = 'fas fa-file-image';
                        else if (['doc', 'docx'].includes(ext)) iconClass = 'fas fa-file-word';
                        
                        return `<i class="${iconClass} file-icon text-primary" title="${file.name}"></i>`;
                    }).join('');
                    
                    const rowClass = daysUntilExpiry < 0 ? 'expired' : (daysUntilExpiry <= 30 ? 'expiring' : '');
                    
                    const row = document.createElement('tr');
                    if (rowClass) row.classList.add(rowClass);
                    
                    row.innerHTML = `
                        <td>${serialNumber}</td>
                        <td>${report.supplier}</td>
                        <td>${report.productNames.join(', ')}</td>
                        <td>${report.productCodes.join(', ')}</td>
                        <td>${fileIcons}</td>
                        <td>${uploadDate}</td>
                        <td>${expiryDate}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${report.remarks || '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info view-btn" data-id="${report.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning edit-btn" data-id="${report.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${report.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    reportsTableBody.appendChild(row);
                });
                
                // 添加事件监听器到操作按钮
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        viewReport(id);
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        editReport(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteReport(id);
                    });
                });
            }
            
            updatePagination();
            updateDisplayCount();
        }
        
        // 更新分页
        function updatePagination() {
            const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">上一页</a>`;
            prevLi.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            pagination.appendChild(prevLi);
            
            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    renderTable();
                });
                pagination.appendChild(li);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">下一页</a>`;
            nextLi.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
            pagination.appendChild(nextLi);
        }
        
        // 更新显示计数
        function updateDisplayCount() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, filteredReports.length);
            
            document.getElementById('displayCount').textContent = 
                filteredReports.length > 0 ? `${startIndex}-${endIndex}` : '0';
            document.getElementById('totalCount').textContent = filteredReports.length;
        }
        
        // 查看报告
        function viewReport(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;
            
            document.getElementById('viewSupplier').textContent = report.supplier;
            document.getElementById('viewProductNames').textContent = report.productNames.join(', ');
            document.getElementById('viewProductCodes').textContent = report.productCodes.join(', ');
            document.getElementById('viewUploadDate').textContent = new Date(report.uploadDate).toLocaleDateString();
            document.getElementById('viewExpiryDate').textContent = new Date(report.expiryDate).toLocaleDateString();
            document.getElementById('viewRemarks').textContent = report.remarks || '-';
            
            // 状态
            const now = new Date();
            const expiry = new Date(report.expiryDate);
            const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            
            let statusText, statusClass;
            
            if (daysUntilExpiry < 0) {
                statusText = '已过期';
                statusClass = 'status-expired';
            } else if (daysUntilExpiry <= 30) {
                statusText = `${daysUntilExpiry}天后过期`;
                statusClass = 'status-expiring';
            } else {
                statusText = '有效';
                statusClass = 'status-valid';
            }
            
            const statusBadge = document.getElementById('viewStatus');
            statusBadge.textContent = statusText;
            statusBadge.className = `status-badge ${statusClass}`;
            
            // 文件列表
            const fileListContainer = document.getElementById('viewFileList');
            fileListContainer.innerHTML = '';
            
            if (report.files.length === 0) {
                fileListContainer.innerHTML = '<p class="text-muted">暂无文件</p>';
            } else {
                const fileList = document.createElement('div');
                fileList.className = 'list-group';
                
                report.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const ext = file.name.split('.').pop().toLowerCase();
                    let iconClass = 'fas fa-file';
                    
                    if (ext === 'pdf') iconClass = 'fas fa-file-pdf text-danger';
                    else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) iconClass = 'fas fa-file-image text-success';
                    else if (['doc', 'docx'].includes(ext)) iconClass = 'fas fa-file-word text-primary';
                    
                    fileItem.innerHTML = `
                        <div>
                            <i class="${iconClass} me-2"></i>
                            ${file.name}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary download-file-btn" data-url="${file.url}" data-name="${file.name}">
                                <i class="fas fa-download"></i> 下载
                            </button>
                            <button class="btn btn-sm btn-outline-info view-file-btn" data-url="${file.url}">
                                <i class="fas fa-eye"></i> 查看
                            </button>
                        </div>
                    `;
                    
                    fileList.appendChild(fileItem);
                });
                
                fileListContainer.appendChild(fileList);
                
                // 添加文件操作事件监听器
                document.querySelectorAll('.download-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const url = this.getAttribute('data-url');
                        const name = this.getAttribute('data-name');
                        downloadFile(url, name);
                    });
                });
                
                document.querySelectorAll('.view-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const url = this.getAttribute('data-url');
                        window.open(url, '_blank');
                    });
                });
            }
            
            viewReportModal.show();
        }
        
        // 编辑报告
        function editReport(id) {
            const report = reports.find(r => r.id === id);
            if (!report) return;
            
            document.getElementById('reportModalLabel').textContent = '编辑供应商SGS报告';
            document.getElementById('reportId').value = report.id;
            document.getElementById('supplier').value = report.supplier;
            document.getElementById('productNames').value = report.productNames.join(', ');
            document.getElementById('productCodes').value = report.productCodes.join(', ');
            document.getElementById('uploadDate').value = report.uploadDate;
            document.getElementById('expiryDate').value = report.expiryDate;
            document.getElementById('remarks').value = report.remarks;
            
            // 显示现有文件
            uploadedFiles = [...report.files];
            renderFileList();
            
            reportModal.show();
        }
        
        // 保存报告
        async function saveReport() {
            // 验证表单
            if (!reportForm.checkValidity()) {
                reportForm.reportValidity();
                return;
            }
            
            const id = document.getElementById('reportId').value;
            const supplier = document.getElementById('supplier').value;
            const productNames = document.getElementById('productNames').value.split(',').map(name => name.trim()).filter(name => name);
            const productCodes = document.getElementById('productCodes').value.split(',').map(code => code.trim()).filter(code => code);
            const uploadDate = document.getElementById('uploadDate').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const remarks = document.getElementById('remarks').value;
            
            try {
                let report;
                
                if (id) {
                    // 更新现有报告
                    report = AV.Object.createWithoutData('SGSReport', id);
                } else {
                    // 创建新报告
                    report = new AV.Object('SGSReport');
                }
                
                report.set('supplier', supplier);
                report.set('productNames', productNames);
                report.set('productCodes', productCodes);
                report.set('uploadDate', uploadDate);
                report.set('expiryDate', expiryDate);
                report.set('remarks', remarks);
                
                // 处理文件
                if (uploadedFiles.length > 0) {
                    // 上传新文件
                    const avFiles = [];
                    
                    for (const file of uploadedFiles) {
                        if (file.avFile) {
                            // 文件已上传，直接使用
                            avFiles.push(file.avFile);
                        } else {
                            // 新文件，需要上传
                            const avFile = new AV.File(file.name, file);
                            await avFile.save();
                            avFiles.push(avFile);
                        }
                    }
                    
                    report.set('files', avFiles.map(avFile => {
                        return {
                            name: avFile.get('name'),
                            url: avFile.get('url'),
                            objectId: avFile.id
                        };
                    }));
                } else {
                    report.set('files', []);
                }
                
                await report.save();
                
                // 删除标记为删除的文件
                for (const fileToDelete of filesToDelete) {
                    if (fileToDelete.objectId) {
                        const file = AV.Object.createWithoutData('_File', fileToDelete.objectId);
                        await file.destroy();
                    }
                }
                
                // 重置删除列表
                filesToDelete = [];
                
                reportModal.hide();
                await loadReports();
                
                alert(id ? '报告更新成功!' : '报告添加成功!');
            } catch (error) {
                console.error('保存报告失败:', error);
                alert('保存报告失败，请检查控制台日志。');
            }
        }
        
        // 删除报告
        async function deleteReport(id) {
            if (!confirm('确定要删除此报告吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const report = AV.Object.createWithoutData('SGSReport', id);
                
                // 删除关联的文件
                const reportObj = reports.find(r => r.id === id);
                if (reportObj && reportObj.files) {
                    for (const file of reportObj.files) {
                        if (file.objectId) {
                            const avFile = AV.Object.createWithoutData('_File', file.objectId);
                            await avFile.destroy();
                        }
                    }
                }
                
                await report.destroy();
                await loadReports();
                
                alert('报告删除成功!');
            } catch (error) {
                console.error('删除报告失败:', error);
                alert('删除报告失败，请检查控制台日志。');
            }
        }
        
        // 处理文件选择
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }
        
        // 处理文件
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 检查文件大小 (最大10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`文件 "${file.name}" 超过10MB限制，无法上传。`);
                    continue;
                }
                
                // 检查文件类型
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert(`文件 "${file.name}" 类型不支持，请上传PDF、JPG或PNG文件。`);
                    continue;
                }
                
                // 添加到上传文件列表
                uploadedFiles.push(file);
            }
            
            renderFileList();
            fileInput.value = ''; // 重置文件输入
        }
        
        // 渲染文件列表
        function renderFileList() {
            fileList.innerHTML = '';
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '<p class="text-muted text-center">暂无文件</p>';
                return;
            }
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const ext = file.name.split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file';
                
                if (ext === 'pdf') iconClass = 'fas fa-file-pdf text-danger';
                else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) iconClass = 'fas fa-file-image text-success';
                else if (['doc', 'docx'].includes(ext)) iconClass = 'fas fa-file-word text-primary';
                
                fileItem.innerHTML = `
                    <div>
                        <i class="${iconClass} me-2"></i>
                        ${file.name}
                        <small class="text-muted">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-sm btn-outline-danger delete-file-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // 添加删除文件事件监听器
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteFile(index);
                });
            });
        }
        
        // 删除文件
        function deleteFile(index) {
            const file = uploadedFiles[index];
            
            // 如果文件已经上传到LeanCloud，标记为需要删除
            if (file.avFile || file.objectId) {
                filesToDelete.push(file);
            }
            
            uploadedFiles.splice(index, 1);
            renderFileList();
        }
        
        // 下载文件
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('reportModalLabel').textContent = '添加供应商SGS报告';
            document.getElementById('reportId').value = '';
            document.getElementById('reportForm').reset();
            uploadedFiles = [];
            filesToDelete = [];
            renderFileList();
        }
        
        // 导入数据
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(data)) {
                            alert('导入的文件格式不正确，应该是一个JSON数组。');
                            return;
                        }
                        
                        if (confirm(`确定要导入 ${data.length} 条记录吗？`)) {
                            importReports(data);
                        }
                    } catch (error) {
                        console.error('解析JSON失败:', error);
                        alert('解析JSON文件失败，请检查文件格式。');
                    }
                };
                
                reader.readAsText(file);
            });
            
            input.click();
        }
        
        // 导入报告
        async function importReports(data) {
            try {
                for (const item of data) {
                    const report = new AV.Object('SGSReport');
                    
                    report.set('supplier', item.supplier || '');
                    report.set('productNames', item.productNames || []);
                    report.set('productCodes', item.productCodes || []);
                    report.set('uploadDate', item.uploadDate || new Date().toISOString().split('T')[0]);
                    report.set('expiryDate', item.expiryDate || new Date().toISOString().split('T')[0]);
                    report.set('remarks', item.remarks || '');
                    report.set('files', item.files || []);
                    
                    await report.save();
                }
                
                await loadReports();
                alert(`成功导入 ${data.length} 条记录!`);
            } catch (error) {
                console.error('导入报告失败:', error);
                alert('导入报告失败，请检查控制台日志。');
            }
        }
        
        // 导出数据
        function exportData() {
            const dataToExport = reports.map(report => {
                return {
                    supplier: report.supplier,
                    productNames: report.productNames,
                    productCodes: report.productCodes,
                    uploadDate: report.uploadDate,
                    expiryDate: report.expiryDate,
                    remarks: report.remarks,
                    files: report.files,
                    createdAt: report.createdAt,
                    updatedAt: report.updatedAt
                };
            });
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sgs_reports_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }
        
        // 打印表格
        function printTable() {
            const tableHtml = `
                <h2>供应商SGS报告列表</h2>
                <p>生成时间: ${new Date().toLocaleString()}</p>
                ${document.getElementById('reportsTable').outerHTML}
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>供应商SGS报告</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            tr.expired { background-color: #ffe6e6; }
                            tr.expiring { background-color: #fff9e6; }
                        </style>
                    </head>
                    <body>
                        ${tableHtml}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>